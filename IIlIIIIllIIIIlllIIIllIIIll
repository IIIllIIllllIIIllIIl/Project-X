-- VF Staff alert by we1qxpo7j8fgkh3ok0ji
-- ESP toggle (T)
-- Current Staff (F1)
-- Join + Leave sounds

local GROUP_ID = 128056089

local Players          = game:GetService("Players")
local StarterGui       = game:GetService("StarterGui")
local CoreGui          = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")
local SoundService     = game:GetService("SoundService")

-- === AUDIO CONFIG ===
local JOIN_SOUND_ID  = "rbxassetid://8887499160"
local LEAVE_SOUND_ID = "rbxassetid://1091083826"
local JOIN_VOLUME    = 2
local LEAVE_VOLUME   = 2

local function playOnce(soundId, volume)
    local s = Instance.new("Sound")
    s.SoundId = soundId
    s.Volume = volume or 2
    s.Looped = false
    s.PlayOnRemove = false
    s.Parent = SoundService
    local ok = pcall(function() SoundService:PlayLocalSound(s) end)
    if not ok then pcall(function() s:Play() end) end
    s.Ended:Connect(function() if s.Parent then s:Destroy() end end)
end
-- === END AUDIO CONFIG ===

-- === UNDERCOVER WATCHLIST (UserIds) ===
local UNDERCOVER_USERIDS = {
    [10404456287] = true,
    [10413647879] = true,
    [10279815564] = true,
    [7558939520]  = true,
    [7208442785]  = true,
    [856837596]   = true,
    [3869228]     = true,
    [14365765]    = true,
    [375117549]   = true,
    [1537923218]  = true,
    [570642875]   = true,
    [35301832]    = true,
    [3860151481]  = true,
    [1649686630]  = true,
    [2290651851]  = true,
    [4423560567]  = true,
    [167515541]   = true,
    [2734316662]  = true,
    [2799921403]  = true,
    [3685035204]  = true,
    [3270461823]  = true,
    [3740191158]  = true,
    [1617828795]  = true,
    [1987394728]  = true,
    [3889850179]  = true,
    [5003063221]  = true,
    [32435725]    = true,
    [1236712946]  = true,
    [1572762983]  = true,
    [5644420194]  = true,
    [1094365126]  = true,
    [461435528]   = true,
    [4138598689]  = true,
    [3812472402]  = true,
    [9821294795]  = true,
    [10423842558] = true,
    [4559062275]  = true,
    [2912939789]  = true,
}

local function isUndercoverWatched(userId)
    return UNDERCOVER_USERIDS[userId] == true
end

local SPECIAL_TAGS = {
    [2309457259] = "ðŸ‘‘",
    [9242413057] = "ðŸª",
}
local tagLoops = {}

local function getSpecialEmoji(userId)
    return SPECIAL_TAGS[userId]
end

local function desiredSpecialDisplay(player)
    local emoji = getSpecialEmoji(player.UserId)
    if not emoji then return nil end
    return ("[%s] %s"):format(emoji, player.DisplayName)
end

local function applySpecialTagOnce(char, player)
    if not char or not player then return end
    local desired = desiredSpecialDisplay(player)
    if not desired then return end

    local hum = char:FindFirstChildOfClass("Humanoid")
    if not hum then return end

    if hum.DisplayName ~= desired then
        hum.DisplayName = desired
    end
end

local function startSpecialTagLoop(player)
    if not player then return end
    if not getSpecialEmoji(player.UserId) then return end
    if tagLoops[player.UserId] then return end

    tagLoops[player.UserId] = true
    task.spawn(function()
        while tagLoops[player.UserId] and player.Parent do
            local char = player.Character
            if char then
                local hum = char:FindFirstChildOfClass("Humanoid")
                if hum then
                    local desired = desiredSpecialDisplay(player)
                    if desired and hum.DisplayName ~= desired then
                        hum.DisplayName = desired
                    end
                end
            end
            task.wait(0.5)
        end
    end)
end

local function stopSpecialTagLoop(player)
    if not player then return end
    tagLoops[player.UserId] = nil
end

-- === UI helpers ===
local function setCoreSafe(key, payload)
    pcall(StarterGui.SetCore, StarterGui, key, payload)
end

local function toast(msg, dur)
    setCoreSafe("SendNotification", { Title = "Staff Alert", Text = tostring(msg), Duration = dur or 3 })
end

-- === Group + thumbnail helpers ===
local function safeIsInGroup(player, groupId)
    local ok, result = pcall(function() return player:IsInGroup(groupId) end)
    return ok and result
end

local function safeGetRoleInGroup(player, groupId)
    local ok, role = pcall(function() return player:GetRoleInGroup(groupId) end)
    if ok and type(role) == "string" and role ~= "" then
        return role
    end
    return "Member"
end

local function getHeadshot(userId)
    local ok, content = pcall(function()
        return Players:GetUserThumbnailAsync(userId, Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size420x420)
    end)
    return ok and content or "rbxassetid://15059364356"
end

-- === Notifications ===
local function sendJoinNotiWithRole(player)
    local role = safeGetRoleInGroup(player, GROUP_ID)
    setCoreSafe("SendNotification", {
        Title = player.DisplayName,
        Text  = string.format("%s (%s) has joined the server.", player.Name, role),
        Icon  = getHeadshot(player.UserId),
        Duration = 5
    })
end

local function sendLeaveNoti(player)
    setCoreSafe("SendNotification", {
        Title = player.DisplayName,
        Text  = string.format("%s left the server", player.Name),
        Icon  = getHeadshot(player.UserId),
        Duration = 5
    })
end

local function sendUndercoverNoti(player)
    setCoreSafe("SendNotification", {
        Title = player.DisplayName,
        Text  = "CAUTION UNDERCOVER STAFF HAS JOINED THE SERVER",
        Icon  = getHeadshot(player.UserId),
        Duration = 6
    })
end

-- === ESP folders ===
local StaffESPFolder = CoreGui:FindFirstChild("StaffESP") or Instance.new("Folder")
StaffESPFolder.Name = "StaffESP"
StaffESPFolder.Parent = CoreGui

local UndercoverESPFolder = CoreGui:FindFirstChild("UndercoverStaffESP") or Instance.new("Folder")
UndercoverESPFolder.Name = "UndercoverStaffESP"
UndercoverESPFolder.Parent = CoreGui

local espEnabled = true

local function applyToggleToAll()
    for _, folder in ipairs({StaffESPFolder, UndercoverESPFolder}) do
        for _, obj in ipairs(folder:GetChildren()) do
            if obj:IsA("Highlight") then obj.Enabled = espEnabled end
        end
    end
    toast(("ESP: %s"):format(espEnabled and "ON" or "OFF"))
end

UserInputService.InputBegan:Connect(function(input, gp)
    if gp or UserInputService:GetFocusedTextBox() then return end

    if input.KeyCode == Enum.KeyCode.T then
        espEnabled = not espEnabled
        applyToggleToAll()

    elseif input.KeyCode == Enum.KeyCode.F1 then
        -- Show who is currently in the server:
        -- - In-group staff
        -- - Undercover watchlist users who are NOT in the group
        local entries = {}

        for _, plr in ipairs(Players:GetPlayers()) do
            local inGroup = safeIsInGroup(plr, GROUP_ID)

            if inGroup then
                table.insert(entries, string.format("%s (@%s)", plr.DisplayName, plr.Name))
            elseif isUndercoverWatched(plr.UserId) then
                table.insert(entries, string.format("âš  UNDERCOVER: %s (@%s)", plr.DisplayName, plr.Name))
            end
        end

        if #entries == 0 then
            toast("No Staff or Undercover users online.", 4)
        else
            local list = table.concat(entries, ", ")
            if #list > 180 then list = list:sub(1, 177) .. "..." end
            toast(string.format("Staff online (%d): %s", #entries, list), 6)
        end
    end
end)

-- === Staff Highlight helpers (rainbow) ===
local function staffHlKeyForPlayer(player) return "HL_" .. tostring(player.UserId) end

local function getOrCreateStaffHighlightForPlayer(player)
    local key = staffHlKeyForPlayer(player)
    local hl = StaffESPFolder:FindFirstChild(key)
    if not hl then
        hl = Instance.new("Highlight")
        hl.Name = key
        hl.FillTransparency = 0.55
        hl.OutlineTransparency = 0.1
        hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        hl.Parent = StaffESPFolder
    end
    hl.Enabled = espEnabled
    return hl
end

local function attachStaffChar(player, char)
    if not player or not char then return end
    local hl = getOrCreateStaffHighlightForPlayer(player)
    hl.Adornee = char
    hl.Enabled = espEnabled
    applySpecialTagOnce(char, player)
end

local function detachStaffChar(player)
    if not player then return end
    local hl = StaffESPFolder:FindFirstChild(staffHlKeyForPlayer(player))
    if hl then hl.Adornee = nil end
end

local function applyESPIfStaff(player)
    if not player or not player.Parent then return end
    if not safeIsInGroup(player, GROUP_ID) then return end

    sendJoinNotiWithRole(player)
    getOrCreateStaffHighlightForPlayer(player)

    if player.Character then
        attachStaffChar(player, player.Character)
    end
    player.CharacterAdded:Connect(function(char)
        attachStaffChar(player, char)
    end)
    player.CharacterRemoving:Connect(function(_) detachStaffChar(player) end)
end

-- === Undercover Highlight helpers (RED) ===
local function undercoverHlKeyForPlayer(player) return "UHL_" .. tostring(player.UserId) end

local function getOrCreateUndercoverHighlightForPlayer(player)
    local key = undercoverHlKeyForPlayer(player)
    local hl = UndercoverESPFolder:FindFirstChild(key)
    if not hl then
        hl = Instance.new("Highlight")
        hl.Name = key
        hl.FillTransparency = 0.55
        hl.OutlineTransparency = 0.1
        hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        hl.FillColor = Color3.fromRGB(255, 0, 0)
        hl.OutlineColor = Color3.fromRGB(255, 0, 0)
        hl.Parent = UndercoverESPFolder
    end
    hl.Enabled = espEnabled
    return hl
end

local function attachUndercoverChar(player, char)
    if not player or not char then return end
    local hl = getOrCreateUndercoverHighlightForPlayer(player)
    hl.Adornee = char
    hl.Enabled = espEnabled
    applySpecialTagOnce(char, player)
end

local function detachUndercoverChar(player)
    if not player then return end
    local hl = UndercoverESPFolder:FindFirstChild(undercoverHlKeyForPlayer(player))
    if hl then hl.Adornee = nil end
end

local function applyESPIfUndercover(player)
    if not player or not player.Parent then return end
    if not isUndercoverWatched(player.UserId) then return end
    if safeIsInGroup(player, GROUP_ID) then return end

    sendUndercoverNoti(player)
    getOrCreateUndercoverHighlightForPlayer(player)

    if player.Character then
        attachUndercoverChar(player, player.Character)
    end
    player.CharacterAdded:Connect(function(char)
        attachUndercoverChar(player, char)
    end)
    player.CharacterRemoving:Connect(function(_) detachUndercoverChar(player) end)
end

-- Rainbow colors for STAFF highlights only (do NOT affect undercover red)
task.spawn(function()
    local hue = 0
    while true do
        hue = (hue + 0.01) % 1
        local color = Color3.fromHSV(hue, 1, 1)
        for _, obj in ipairs(StaffESPFolder:GetChildren()) do
            if obj:IsA("Highlight") then
                obj.FillColor = color
                obj.OutlineColor = color
            end
        end
        task.wait(0.05)
    end
end)

-- Startup: quiet (no sounds for existing players)
toast("Staff Alert started (T = toggle ESP, F1 = Current Staff)", 5)

for _, plr in ipairs(Players:GetPlayers()) do
    -- Special emoji tags apply regardless
    if getSpecialEmoji(plr.UserId) then
        startSpecialTagLoop(plr)
        if plr.Character then applySpecialTagOnce(plr.Character, plr) end
        plr.CharacterAdded:Connect(function(char) applySpecialTagOnce(char, plr) end)
    end

    -- Real staff: notif + rainbow ESP
    applyESPIfStaff(plr)

    -- Undercover: CAUTION notif + red ESP
    applyESPIfUndercover(plr)
end

-- Join logic:
-- 1) If undercover ID joins and NOT in group -> CAUTION + red ESP + SAME join sound
-- 2) If in group -> staff join message with role + rainbow ESP + join sound
Players.PlayerAdded:Connect(function(plr)
    -- Start special tag loop immediately if applicable
    if getSpecialEmoji(plr.UserId) then
        startSpecialTagLoop(plr)
        if plr.Character then applySpecialTagOnce(plr.Character, plr) end
        plr.CharacterAdded:Connect(function(char) applySpecialTagOnce(char, plr) end)
    end

    local inGroup = safeIsInGroup(plr, GROUP_ID)

    if isUndercoverWatched(plr.UserId) and not inGroup then
        playOnce(JOIN_SOUND_ID, JOIN_VOLUME) -- same as normal
        applyESPIfUndercover(plr)
        return
    end

    if inGroup then
        playOnce(JOIN_SOUND_ID, JOIN_VOLUME)
        applyESPIfStaff(plr)
    end
end)

-- Leave: keep original behavior (leave sound + leave noti only for in-group)
Players.PlayerRemoving:Connect(function(plr)
    if safeIsInGroup(plr, GROUP_ID) then
        sendLeaveNoti(plr)
        playOnce(LEAVE_SOUND_ID, LEAVE_VOLUME)
    end
    detachStaffChar(plr)
    detachUndercoverChar(plr)
    stopSpecialTagLoop(plr)
end)

do
    local TextChatService = game:GetService("TextChatService")
    local Lighting = game:GetService("Lighting")
    local RunService = game:GetService("RunService")
    local Players2 = game:GetService("Players")
    local SoundService2 = game:GetService("SoundService")

    local localPlayer = Players2.LocalPlayer

    -- Sound asset
    local JUJU_SOUND_ID = "rbxassetid://103606830325471"
    local JUJU_TARGET_VOLUME = 4
    local JUJU_START_TIME = 13

    -- Fade settings (sound)
    local JUJU_FADE_TIME = 3
    local JUJU_FADE_STEPS = 20

    -- Disco settings (Lighting-only â€œscreen effectsâ€)
    local JUJU_DISCO_SPEED = 0.25
    local JUJU_DISCO_FADE_TIME = 1.0

    local currentSound = nil
    local busy = false

    local discoOn = false
    local discoConn = nil
    local discoFadeTweening = false

    local original = {
        Ambient = Lighting.Ambient,
        OutdoorAmbient = Lighting.OutdoorAmbient,
        ColorShift_Top = Lighting.ColorShift_Top,
        ColorShift_Bottom = Lighting.ColorShift_Bottom,
        Brightness = Lighting.Brightness,
    }

    local function fadeVolume(sound, fromVol, toVol)
        if not sound then return end
        for i = 1, JUJU_FADE_STEPS do
            if not sound or not sound.Parent then return end
            local alpha = i / JUJU_FADE_STEPS
            sound.Volume = fromVol + (toVol - fromVol) * alpha
            task.wait(JUJU_FADE_TIME / JUJU_FADE_STEPS)
        end
    end

    local function lerpColor(a, b, t)
        return Color3.new(
            a.R + (b.R - a.R) * t,
            a.G + (b.G - a.G) * t,
            a.B + (b.B - a.B) * t
        )
    end

    local function lerpNumber(a, b, t)
        return a + (b - a) * t
    end

    local function fadeLightingTo(target, duration)
        if discoFadeTweening then return end
        discoFadeTweening = true

        local start = {
            Ambient = Lighting.Ambient,
            OutdoorAmbient = Lighting.OutdoorAmbient,
            ColorShift_Top = Lighting.ColorShift_Top,
            ColorShift_Bottom = Lighting.ColorShift_Bottom,
            Brightness = Lighting.Brightness,
        }

        local t0 = os.clock()
        while true do
            local t = (os.clock() - t0) / duration
            if t >= 1 then t = 1 end

            Lighting.Ambient = lerpColor(start.Ambient, target.Ambient, t)
            Lighting.OutdoorAmbient = lerpColor(start.OutdoorAmbient, target.OutdoorAmbient, t)
            Lighting.ColorShift_Top = lerpColor(start.ColorShift_Top, target.ColorShift_Top, t)
            Lighting.ColorShift_Bottom = lerpColor(start.ColorShift_Bottom, target.ColorShift_Bottom, t)
            Lighting.Brightness = lerpNumber(start.Brightness, target.Brightness, t)

            if t >= 1 then break end
            task.wait()
        end

        discoFadeTweening = false
    end

    local function stopDisco()
        discoOn = false
        if discoConn then
            discoConn:Disconnect()
            discoConn = nil
        end

        task.spawn(function()
            fadeLightingTo(original, JUJU_DISCO_FADE_TIME)
        end)
    end

    local function startDisco()
        if discoOn then return end
        discoOn = true

        task.spawn(function()
            fadeLightingTo({
                Ambient = original.Ambient,
                OutdoorAmbient = original.OutdoorAmbient,
                ColorShift_Top = original.ColorShift_Top,
                ColorShift_Bottom = original.ColorShift_Bottom,
                Brightness = math.max(original.Brightness, 2),
            }, JUJU_DISCO_FADE_TIME)
        end)

        local hue = 0
        discoConn = RunService.RenderStepped:Connect(function(dt)
            if not discoOn then return end
            hue = (hue + dt * JUJU_DISCO_SPEED) % 1
            local c = Color3.fromHSV(hue, 1, 1)

            Lighting.Ambient = c
            Lighting.OutdoorAmbient = c
            Lighting.ColorShift_Top = c
            Lighting.ColorShift_Bottom = c
        end)
    end

    local function stopSound()
        if currentSound then
            local s = currentSound
            currentSound = nil

            fadeVolume(s, s.Volume, 0)
            s:Stop()
            s:Destroy()
        end
    end

    local function playSound()
        stopSound()

        local s = Instance.new("Sound")
        s.SoundId = JUJU_SOUND_ID
        s.Volume = 0
        s.Parent = SoundService2

        s.TimePosition = JUJU_START_TIME

        currentSound = s
        s:Play()

        fadeVolume(s, 0, JUJU_TARGET_VOLUME)

        s.Ended:Connect(function()
            if currentSound == s then
                currentSound = nil
            end
            s:Destroy()
            stopDisco()
        end)
    end

    local function toggleParty()
        if busy then return end
        busy = true

        if currentSound and currentSound.IsPlaying then
            stopSound()
            stopDisco()
        else
            startDisco()
            playSound()
        end

        task.delay(0.2, function()
            busy = false
        end)
    end

    TextChatService.MessageReceived:Connect(function(message)
        if message.TextSource and message.TextSource.UserId == localPlayer.UserId then
            local text = string.lower(message.Text):gsub("^%s*(.-)%s*$", "%1")
            if text == "juju" then
                toggleParty()
            end
        end
    end)
end
